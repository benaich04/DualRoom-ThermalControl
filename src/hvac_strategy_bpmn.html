<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BPMN Flow – Two‑Room Temperature Controller</title>
<style>
  :root {
    --lane-h: 180px;
    --lane-w: 1380px;
    --swim-w: 1420px;
    --swim-h: 6 * var(--lane-h);
    --box-fill: #fff;
    --box-stroke: #111;
    --gw-fill: #eef6ff;
    --sp-fill: #f7fff0;
    --task-fill: #ffffff;
    --fault-fill: #fff4f4;
    --text: #111;
    --accent: #2563eb;
    --accent2: #16a34a;
    --accent3: #f59e0b;
    --danger: #ef4444;
  }
  html, body { margin: 0; padding: 0; background:#fafafa; color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
  header { padding: 16px 20px; background:#111827; color:#fff; }
  header h1 { margin: 0 0 6px 0; font-size: 20px; }
  header p { margin: 0; opacity: .85; font-size: 14px; }
  .canvas { overflow:auto; padding: 18px; }
  .legend { margin: 10px 0 18px 0; display:flex; flex-wrap:wrap; gap:12px; font-size:12px; }
  .legend span { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid #ddd; border-radius:6px; background:#fff; }
  .swim-title { font-weight: 700; font-size: 13px; }
  svg { background:#ffffff; border:1px solid #e5e7eb; border-radius:10px; box-shadow: 0 8px 24px rgba(0,0,0,.06); }
  /* BPMN-ish shapes */
  .task { fill: var(--task-fill); stroke: var(--box-stroke); stroke-width:1.2; rx:10; }
  .subp { fill: var(--sp-fill); stroke: var(--box-stroke); stroke-width:1.2; rx:14; }
  .gateway { fill: var(--gw-fill); stroke: var(--box-stroke); stroke-width:1.2; }
  .event { fill: #fff; stroke: var(--accent); stroke-width:2.2; }
  .timer { stroke: var(--accent3); }
  .end { stroke: var(--danger); stroke-width:2.2; }
  .fault { fill: var(--fault-fill); stroke: var(--danger); stroke-width:1.6; rx:12; }
  .line { stroke:#111; stroke-width:1.4; marker-end:url(#arrow); }
  .line-dash { stroke:#6b7280; stroke-width:1.3; stroke-dasharray:5 5; marker-end:url(#arrow); }
  .sig { stroke: var(--accent2); stroke-width:1.6; marker-end:url(#arrow); }
  .label { font-size: 12px; fill:#111; }
  .tiny { font-size: 10.5px; fill:#374151; }
  .lane { fill:#f8fafc; stroke:#cbd5e1; }
  .lane-sep { stroke:#d1d5db; stroke-width:1; }
  .pool-title { font-weight:700; font-size: 14px; }
</style>
</head>
<body>
<header>
  <h1>BPMN Flow – Two‑Room Closed‑Loop Temperature Control</h1>
  <p>ECE4144 · Feather 32U4 · Two TMP61 sensors → two dampers (PWM) → 2‑stage heating (active‑low GPIO)</p>
</header>
<div class="canvas">
  <div class="legend">
    <span><svg width="18" height="14"><rect x="2" y="2" width="14" height="10" rx="4" fill="#fff" stroke="#111"/></svg> Task</span>
    <span><svg width="18" height="14"><rect x="2" y="2" width="14" height="10" rx="6" fill="#f7fff0" stroke="#111"/></svg> Sub‑Process</span>
    <span><svg width="18" height="14"><polygon points="9,2 16,9 9,16 2,9" fill="#eef6ff" stroke="#111"/></svg> Exclusive/Parallel Gateway</span>
    <span><svg width="18" height="14"><circle cx="9" cy="9" r="6" fill="#fff" stroke="#2563eb"/></svg> Event</span>
    <span><svg width="18" height="14"><rect x="2" y="2" width="14" height="10" rx="6" fill="#fff4f4" stroke="#ef4444"/></svg> Fault/Safe Mode</span>
  </div>

  <!-- Main SVG Diagram -->
  <svg width="1600" height="1160" viewBox="0 0 1600 1160" aria-label="BPMN diagram">
    <!-- markers -->
    <defs>
      <marker id="arrow" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="7" markerHeight="7" orient="auto-start-reverse">
        <path d="M 0 0 L 10 5 L 0 10 z" fill="#111" />
      </marker>
    </defs>

    <!-- Pool Title -->
    <text x="20" y="28" class="pool-title">Pool: Embedded Controller (Feather 32U4)</text>

    <!-- Swimlanes background -->
    <g>
      <rect x="10" y="40" width="1580" height="180" class="lane" />
      <rect x="10" y="220" width="1580" height="180" class="lane" />
      <rect x="10" y="400" width="1580" height="180" class="lane" />
      <rect x="10" y="580" width="1580" height="180" class="lane" />
      <rect x="10" y="760" width="1580" height="180" class="lane" />
      <rect x="10" y="940" width="1580" height="180" class="lane" />
      <!-- lane titles -->
      <text x="20" y="66" class="swim-title">Scheduler / Loop</text>
      <text x="20" y="246" class="swim-title">ADC & Sensors</text>
      <text x="20" y="426" class="swim-title">Room 1 Dampers</text>
      <text x="20" y="606" class="swim-title">Room 2 Dampers</text>
      <text x="20" y="786" class="swim-title">Heating System</text>
      <text x="20" y="966" class="swim-title">Fault Manager / Logging</text>
      <!-- separators -->
      <line x1="10" y1="220" x2="1590" y2="220" class="lane-sep" />
      <line x1="10" y1="400" x2="1590" y2="400" class="lane-sep" />
      <line x1="10" y1="580" x2="1590" y2="580" class="lane-sep" />
      <line x1="10" y1="760" x2="1590" y2="760" class="lane-sep" />
      <line x1="10" y1="940" x2="1590" y2="940" class="lane-sep" />
    </g>

    <!-- Start / Timer Event (Scheduler) -->
    <circle cx="110" cy="110" r="20" class="event timer" stroke-width="3" fill="#fff" />
    <text x="150" y="116" class="label">Timer Start (1 Hz Tick)</text>

    <!-- Parallel fork after timer -->
    <polygon points="300,90 330,120 300,150 270,120" class="gateway" />
    <text x="254" y="118" class="tiny">Parallel</text>

    <!-- Branch A: Read & Validate Temps (Sub‑process in Sensors lane) -->
    <rect x="420" y="260" width="280" height="120" class="subp" />
    <text x="560" y="285" text-anchor="middle" class="label">Read &amp; Validate Temperatures</text>
    <text x="560" y="305" text-anchor="middle" class="tiny">ADC0→T1, ADC1→T2 (free‑run, mux settle, fit)</text>
    <text x="560" y="323" text-anchor="middle" class="tiny">Plausibility: volts, range, dT/dt</text>

    <!-- Boundary Error events on sub-process (sensors) -->
    <circle cx="420" cy="260" r="10" class="event" stroke="#ef4444" />
    <circle cx="420" cy="300" r="10" class="event" stroke="#ef4444" />
    <text x="438" y="265" class="tiny">Err: R1</text>
    <text x="438" y="305" class="tiny">Err: R2</text>

    <!-- Branch B: Update timers (in Scheduler) -->
    <rect x="420" y="80" width="220" height="60" class="task" />
    <text x="530" y="110" text-anchor="middle" class="label">Update Housekeeping Timers</text>

    <!-- Join gateway after sensors+timers -->
    <polygon points="760,90 790,120 760,150 730,120" class="gateway" />
    <text x="714" y="118" class="tiny">Join</text>

    <!-- Exclusive: Any Sensor Fault? (Scheduler) -->
    <polygon points="920,90 950,120 920,150 890,120" class="gateway" />
    <text x="872" y="118" class="tiny">Any sensor fault?</text>

    <!-- Normal path down to damper branches (parallel) -->
    <polygon points="1090,90 1120,120 1090,150 1060,120" class="gateway" />
    <text x="1036" y="118" class="tiny">Parallel</text>

    <!-- Compute Damper R1 subp (Room1 lane) -->
    <rect x="1220" y="440" width="300" height="110" class="subp" />
    <text x="1370" y="465" text-anchor="middle" class="label">Compute Damper Command (Room 1)</text>
    <text x="1370" y="485" text-anchor="middle" class="tiny">e1 = T_SET − T1; target = clamp(KP·e1,0..100)</text>
    <text x="1370" y="503" text-anchor="middle" class="tiny">Slew to target by SLEW%/s; quiet zone |e1|&lt;0.2°C</text>

    <!-- Compute Damper R2 subp (Room2 lane) -->
    <rect x="1220" y="620" width="300" height="110" class="subp" />
    <text x="1370" y="645" text-anchor="middle" class="label">Compute Damper Command (Room 2)</text>
    <text x="1370" y="665" text-anchor="middle" class="tiny">e2 = T_SET − T2; target = clamp(KP·e2,0..100)</text>
    <text x="1370" y="683" text-anchor="middle" class="tiny">Slew to target by SLEW%/s; quiet zone |e2|&lt;0.2°C</text>

    <!-- Join after dampers -->
    <polygon points="1540,90 1570,120 1540,150 1510,120" class="gateway" />
    <text x="1494" y="118" class="tiny">Join</text>

    <!-- Decide Heat Stage subp (Heating lane) -->
    <rect x="420" y="800" width="360" height="120" class="subp" />
    <text x="600" y="825" text-anchor="middle" class="label">Decide Heating Stage (Hysteresis + Min‑Duration)</text>
    <text x="600" y="845" text-anchor="middle" class="tiny">minT = min(T1,T2), maxT = max(T1,T2)</text>
    <text x="600" y="863" text-anchor="middle" class="tiny">Stage2 if minT ≤ 23.0; Stage1 if minT ≤ 24.5; Off if maxT ≥ 25.5; else hold</text>
    <text x="600" y="881" text-anchor="middle" class="tiny">Respect MIN_OFF, MIN_ON_S1, MIN_ON_S2 vs LastHeatStage</text>

    <!-- Apply Outputs task (Heating lane) -->
    <rect x="820" y="800" width="300" height="120" class="task" />
    <text x="970" y="825" text-anchor="middle" class="label">Apply Outputs</text>
    <text x="970" y="845" text-anchor="middle" class="tiny">OCR0A/B ← Damper% ; GPIOs ← HeatStage</text>

    <!-- End Event (Scheduler lane, right side) -->
    <circle cx="1460" cy="110" r="20" class="event end" fill="#fff" />
    <text x="1496" y="116" class="label">End (Cycle)</text>

    <!-- Safe Mode (Fault lane) -->
    <rect x="420" y="980" width="420" height="120" class="fault" />
    <text x="630" y="1005" text-anchor="middle" class="label">Safe Mode</text>
    <text x="630" y="1025" text-anchor="middle" class="tiny">Log fault; Damper% = 0, HeatStage = 0; Apply now</text>
    <text x="630" y="1043" text-anchor="middle" class="tiny">Backoff 5s → RECOVER_CHECK → N good samples to exit</text>

    <!-- Edges / Flows -->
    <!-- Start → fork -->
    <line x1="130" y1="110" x2="270" y2="110" class="line" />
    <!-- fork → sensors subproc -->
    <line x1="300" y1="120" x2="420" y2="260" class="line" />
    <!-- fork → timers task -->
    <line x1="300" y1="120" x2="420" y2="110" class="line" />
    <!-- timers → join -->
    <line x1="640" y1="110" x2="730" y2="120" class="line" />
    <!-- sensors → join (vertical up) -->
    <line x1="560" y1="380" x2="760" y2="150" class="line" />
    
    <!-- join → Any Sensor Fault? -->
    <line x1="790" y1="120" x2="890" y2="120" class="line" />
    
    <!-- Fault branch to Safe Mode -->
    <line x1="920" y1="150" x2="630" y2="980" class="line" />
    <text x="655" y="690" class="tiny">Yes (fault)</text>

    <!-- Normal branch (No) → parallel dampers fork -->
    <line x1="950" y1="120" x2="1060" y2="120" class="line" />

    <!-- fork → Damper R1 -->
    <line x1="1090" y1="120" x2="1220" y2="440" class="line" />
    <!-- fork → Damper R2 -->
    <line x1="1090" y1="120" x2="1220" y2="620" class="line" />

    <!-- Dampers join back to Scheduler join (for completeness we route to right join) -->
    <line x1="1520" y1="495" x2="1540" y2="150" class="line" />
    <line x1="1520" y1="675" x2="1540" y2="150" class="line" />

    <!-- From right join down to Stage Decision -->
    <line x1="1540" y1="120" x2="980" y2="800" class="line" />

    <!-- Stage Decision → Apply Outputs -->
    <line x1="780" y1="860" x2="820" y2="860" class="line" />

    <!-- Apply Outputs → End (Cycle) back up (diagonal) -->
    <line x1="1120" y1="860" x2="1440" y2="130" class="line" />

    <!-- Boundary error connectors from sensors subproc to Safe Mode (explicit) -->
    <line x1="420" y1="260" x2="420" y2="980" class="line-dash" />
    <line x1="420" y1="300" x2="420" y2="980" class="line-dash" />

    <!-- Signal flow: Safe Mode backoff to Scheduler (RECOVER_CHECK) optional note -->
    <text x="860" y="1060" class="tiny" fill="#16a34a">Signal: RECOVER_CHECK → re-evaluate on next tick</text>

    <!-- Data Annotations (left side) -->
    <text x="20" y="150" class="tiny">Data: T1, T2, Damper1_pct, Damper2_pct, HeatStage</text>
    <text x="20" y="166" class="tiny">Params: T_SET=25, DB_OFF=+0.5, DB_S1=−0.5, DB_S2=−2.0, KP=25, SLEW=20%</text>
    <text x="20" y="182" class="tiny">Min durations: MIN_OFF=120s, MIN_ON_S1=120s, MIN_ON_S2=90s</text>
  </svg>

  <p class="tiny" style="margin-top:10px;color:#374151">Tip: You can copy this file into any static host or open locally. To tweak, adjust coordinates or add more gateways. The shapes follow BPMN semantics: events (circles), gateways (diamonds), tasks (rounded rect), sub‑process (larger rounded rect), error boundaries (red-rim circles) attached to sub‑process.</p>
</div>
</body>
</html>
